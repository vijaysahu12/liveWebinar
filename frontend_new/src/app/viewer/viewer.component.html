<div class="main-container">
  <!-- Top Controls Bar -->
  <div class="top-controls">
    <button class="control-btn" (click)="refreshViewerCount()">🔄 Refresh Count</button>
    <button class="control-btn" (click)="incrementViewerCount()">👍 Like</button>
    <button class="control-btn" (click)="clearUserId()">🗑️ Clear User ID</button>
    <button class="control-btn" (click)="testOfflineMode()">📱 Test Offline</button>

    <div style="flex:1"></div>

    <!-- Status indicators -->
    <div class="status-group">
      <div class="badge">
        Viewers: {{ viewerCount() }} | Total: {{ participants() }}
      </div>
      <div class="small stream-status">{{ streamStatus() }}</div>
      <div class="small connection-status"
        [style.color]="connectionStatus() === 'Connected' ? 'green' : connectionStatus() === 'Offline' ? 'orange' : connectionStatus() === 'Reconnecting...' ? 'blue' : 'gray'">
        @if (connectionStatus() === 'Connected') {
        🟢 Live
        } @else if (connectionStatus() === 'Offline') {
        🟠 Offline Mode
        } @else if (connectionStatus() === 'Reconnecting...') {
        🔵 Connecting...
        } @else {
        ⚪ {{ connectionStatus() }}
        }
      </div>
      <div class="small">Live • <span id="liveTimer">{{ liveTimer() | date:'mm:ss' }}</span></div>
    </div>
  </div>

  <!-- Main Content Area: 70% Video + 30% Chat -->
  <div class="content-area">

    <!-- Left Side: Live Streaming (70%) -->
    <div class="video-section">
      <!-- Event header -->
      <div class="event-header">
        <div style="flex:1">
          <div class="event-title" id="eventTitle">Algo Trading Setup for Crypto</div>
          <div class="event-meta" style="margin-top:6px">
            <div class="pill" id="eventWhen">Event: Sep 30, 2025 • 07:00 PM IST</div>
            <div class="pill" id="eventDuration">Duration: 90 mins</div>
            <div class="pill" id="eventType">Live</div>
          </div>
        </div>
      </div>

      <!-- overlay area for polls/messages/qr -->
      <div class="overlay" id="overlayContainer" aria-live="polite"></div>

      <!-- video player area -->
      <div class="video-area" id="videoArea">
        <iframe id="streamEmbed" src="https://www.youtube.com/embed/2kT42dG4xpg?si=pp0ho09c9_h4hnGj"
          title="YouTube video player" frameborder="0"
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
          referrerpolicy="strict-origin-when-cross-origin" allowfullscreen>
        </iframe>
      </div>
    </div>

    <!-- Right Side: Chat (30%) -->
    <div class="chat-section">
      <div class="chat-header">
        <h3>Live Chat</h3>
        <div class="chat-stats">{{ chatMessages().length }} messages</div>
      </div>

      <div class="chat-messages" #chatContainer>
        @for (message of chatMessages(); track message.id) {
        <div class="chat-message" [class.own-message]="message.userId === userId">
          <div class="message-header">
            <span class="username">{{ message.username }}</span>
            <span class="timestamp">{{ message.timestamp | date:'HH:mm' }}</span>
          </div>
          <div class="message-content">{{ message.message }}</div>
        </div>
        }

        @if (chatMessages().length === 0) {
        <div class="no-messages">
          <p>💬 No messages yet. Start the conversation!</p>
        </div>
        }
      </div>

      <div class="chat-input">
        <input type="text" placeholder="Type your message..." [value]="currentMessage()"
          (input)="updateCurrentMessage($event)" (keypress)="onChatKeyPress($event)" [disabled]="chatInputDisabled()"
          class="message-input" />
        <button (click)="sendChatMessage()" [disabled]="!currentMessage().trim() || chatInputDisabled()"
          class="send-btn">
          Send
        </button>
      </div>
    </div>

  </div>

  <!-- Host controls (minimize/maximize) with participants visible only to host -->
  <div class="host-panel" [class.minimized]="hostPanelMinimized()">
    <div class="host-controls">
      <button (click)="toggleHostPanel()" class="minimize-btn">
        {{ hostPanelMinimized() ? '🔼' : '🔽' }} Host Panel
      </button>
    </div>
    @if (!hostPanelMinimized()) {
    <div class="host-content">
      <div class="participants-section">
        <h4>Host Controls</h4>
        <p>Participants: {{ participants() }}</p>
        <p>Broadcast Status: {{ hostBroadcastStatus() }}</p>

        <label>Push Quick Message</label>
        <div class="form-row">
          <input id="quickMsg" placeholder="Type message to show to all viewers" />
          <button class="control-btn">Push</button>
        </div>

        <label>Create Poll</label>
        <input id="pollQ" placeholder="Poll question" />
        <div class="form-row">
          <input id="opt1" placeholder="Option 1" />
          <input id="opt2" placeholder="Option 2" />
        </div>
      </div>
    </div>
    }
  </div>
</div>