<div class="main-container">
  <!-- Top Controls Bar -->
  <div class="top-controls">
    <button class="control-btn" (click)="refreshViewerCount()">🔄 Refresh Count</button>
    <button class="control-btn" (click)="incrementViewerCount()">👍 Like</button>
    <button class="control-btn" (click)="clearUserId()">🗑️ Clear User ID</button>
    <button class="control-btn" (click)="testOfflineMode()">📱 Test Offline</button>

    <div style="flex:1"></div>

    <!-- Status indicators -->
    <div class="status-group">
      <div class="badge">
        Viewers: {{ viewerCount() }} | Total: {{ participants() }}
      </div>
      <div class="small stream-status">{{ streamStatus() }}</div>
      <div class="small connection-status"
        [style.color]="connectionStatus() === 'Connected' ? 'green' : connectionStatus() === 'Offline' ? 'orange' : connectionStatus() === 'Reconnecting...' ? 'blue' : 'gray'">
        @if (connectionStatus() === 'Connected') {
        🟢 Live
        } @else if (connectionStatus() === 'Offline') {
        🟠 Offline Mode
        } @else if (connectionStatus() === 'Reconnecting...') {
        🔵 Connecting...
        } @else {
        ⚪ {{ connectionStatus() }}
        }
      </div>
      <div class="small">Live • <span id="liveTimer">{{ liveTimer() | date:'mm:ss' }}</span></div>
    </div>
  </div>

  <!-- Main Content Area: 70% Video + 30% Chat -->
  <div class="content-area">

    <!-- Left Side: Live Streaming (70%) -->
    <div class="video-section">
      <!-- Event header -->
      <div class="event-header">
        <div style="flex:1">
          <div class="event-title" id="eventTitle">Algo Trading Setup for Crypto</div>
          <div class="event-meta" style="margin-top:6px">
            <div class="pill" id="eventWhen">Event: Sep 30, 2025 • 07:00 PM IST</div>
            <div class="pill" id="eventDuration">Duration: 90 mins</div>
            <div class="pill" id="eventType">Live</div>
          </div>
        </div>
      </div>

      <!-- overlay area for polls/messages/qr -->
      <div class="overlay" id="overlayContainer" aria-live="polite"></div>

      <!-- video player area -->
      <div class="video-area" id="videoArea">
        <iframe id="streamEmbed" src="https://www.youtube.com/embed/2kT42dG4xpg?si=pp0ho09c9_h4hnGj"
          title="YouTube video player" frameborder="0"
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
          referrerpolicy="strict-origin-when-cross-origin" allowfullscreen>
        </iframe>
      </div>
    </div>

    <!-- Right Side: Chat (30%) -->
    <div class="chat-section">
      <div class="chat-header">
        <h3>Live Chat</h3>
        <div class="chat-stats">{{ chatMessages().length }} messages</div>
      </div>

      <div class="chat-messages" #chatContainer>
        @for (message of chatMessages(); track message.id) {
        <div class="chat-message" [class.own-message]="message.userId === userId">
          <div class="message-header">
            <span class="username">{{ message.username }}</span>
            <span class="timestamp">{{ message.timestamp | date:'HH:mm' }}</span>
          </div>
          <div class="message-content">{{ message.message }}</div>
        </div>
        }

        @if (chatMessages().length === 0) {
        <div class="no-messages">
          <p>💬 No messages yet. Start the conversation!</p>
        </div>
        }
      </div>

      <div class="chat-input">
        <input type="text" placeholder="Type your message..." [value]="currentMessage()"
          (input)="updateCurrentMessage($event)" (keypress)="onChatKeyPress($event)" [disabled]="chatInputDisabled()"
          class="message-input" />
        <button (click)="sendChatMessage()" [disabled]="!currentMessage().trim() || chatInputDisabled()"
          class="send-btn">
          Send
        </button>
      </div>
    </div>

  </div>

  <!-- Host controls (minimize/maximize) with participants visible only to host -->
  <div class="host-panel" [class.minimized]="hostPanelMinimized()">
    <div class="host-controls">
      <button (click)="toggleHostPanel()" class="minimize-btn">
        {{ hostPanelMinimized() ? '🔼' : '🔽' }} Host Panel
      </button>
    </div>
    @if (!hostPanelMinimized()) {
    <div class="host-content">
      <div class="participants-section">
        <h4>Host Controls</h4>
        <p>Participants: {{ participants() }}</p>
        <p>Broadcast Status: {{ hostBroadcastStatus() }}</p>

        <!-- Quick Actions -->
        <div class="quick-actions">
          <h5>🚀 Quick Actions</h5>
          <button class="action-btn poll-btn" (click)="createQuickPoll()">📊 Quick Poll</button>
          <button class="action-btn like-btn" (click)="requestLikes()">❤️ Request Likes</button>
          <button class="action-btn force-btn" (click)="forceLikeRequest()">💓 Force Like</button>
          <button class="action-btn announcement-btn" (click)="sendQuickAnnouncement()">📢 Announce</button>
        </div>

        <!-- QR Code Sharing -->
        <div class="qr-section">
          <h5>📱 QR Code Sharing</h5>
          <button class="action-btn qr-btn" (click)="sharePaymentQR()">💳 Payment QR</button>
          <button class="action-btn qr-btn" (click)="shareDownloadQR()">📲 App Download</button>
        </div>

        <!-- File Sharing -->
        <div class="file-section">
          <h5>📁 File Sharing</h5>
          <button class="action-btn file-btn" (click)="sharePresentation()">📄 Share Slides</button>
          <button class="action-btn file-btn" (click)="shareResources()">📦 Resources</button>
        </div>

        <!-- Custom Poll Creation -->
        <div class="poll-section">
          <h5>📊 Custom Poll</h5>
          <button class="action-btn create-poll-btn" (click)="openPollModal()">
            Create Poll
          </button>
        </div>

        <!-- Announcements -->
        <div class="announcement-section">
          <h5>📢 Custom Announcement</h5>
          <button class="action-btn announcement-btn" (click)="openAnnouncementModal()">
            Send Announcement
          </button>
        </div>

        <!-- Q&A Management -->
        <div class="qa-section">
          <h5>❓ Q&A Management</h5>
          <button class="action-btn qa-btn" (click)="openQAModal()">
            Ask Question
          </button>
        </div>

        <!-- Engagement Analytics -->
        <div class="analytics-section">
          <h5>📈 Engagement Stats</h5>
          <div class="stats-grid">
            <div class="stat-item">
              <span class="stat-label">Total Interactions:</span>
              <span class="stat-value">0</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Active Polls:</span>
              <span class="stat-value">0</span>
            </div>
            <div class="stat-item">
              <span class="stat-label">Questions Asked:</span>
              <span class="stat-value">0</span>
            </div>
          </div>
        </div>

        <!-- Advanced Controls -->
        <div class="advanced-section">
          <h5>⚙️ Advanced Controls</h5>
          <button class="action-btn combo-btn" (click)="quickEngagementActions()">
            🎯 Run Engagement Sequence
          </button>
        </div>
      </div>
    </div>
    }
  </div>
</div>

<!-- Modal Overlays for Engagement Features -->

<!-- Poll Creation Modal -->
<div class="modal-overlay" [class.show]="showPollModal()" (click)="closePollModal()">
  <div class="modal-container poll-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>📊 Create Poll</h3>
      <button class="modal-close" (click)="closePollModal()">×</button>
    </div>
    <div class="modal-content">
      <div class="form-group">
        <label for="pollQuestion">Poll Question</label>
        <input #pollQuestion id="pollQuestion" placeholder="Enter your poll question..." class="modal-input" />
      </div>
      <div class="form-group">
        <label>Poll Options</label>
        <div class="poll-options-input">
          <input #pollOpt1 placeholder="Option 1" class="modal-input" />
          <input #pollOpt2 placeholder="Option 2" class="modal-input" />
          <input #pollOpt3 placeholder="Option 3 (optional)" class="modal-input" />
          <input #pollOpt4 placeholder="Option 4 (optional)" class="modal-input" />
        </div>
      </div>
      <div class="form-group">
        <label>
          <input type="checkbox" #allowMultiple> Allow Multiple Selections
        </label>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" (click)="closePollModal()">Cancel</button>
      <button class="btn-primary" (click)="createPollFromModal()">
        Create Poll
      </button>
    </div>
  </div>
</div>

<!-- Announcement Modal -->
<div class="modal-overlay" [class.show]="showAnnouncementModal()" (click)="closeAnnouncementModal()">
  <div class="modal-container announcement-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>📢 Make Announcement</h3>
      <button class="modal-close" (click)="closeAnnouncementModal()">×</button>
    </div>
    <div class="modal-content">
      <div class="form-group">
        <label for="announcementTitle">Title</label>
        <input #announcementTitle id="announcementTitle" placeholder="Announcement title..." class="modal-input" />
      </div>
      <div class="form-group">
        <label for="announcementText">Message</label>
        <textarea #announcementText id="announcementText" 
                  placeholder="Your announcement message..." 
                  class="modal-textarea" rows="4"></textarea>
      </div>
      <div class="form-group">
        <label>Display Duration</label>
        <select #announcementDuration class="modal-select">
          <option value="5">5 seconds</option>
          <option value="10" selected>10 seconds</option>
          <option value="15">15 seconds</option>
          <option value="30">30 seconds</option>
          <option value="0">Until dismissed</option>
        </select>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" (click)="closeAnnouncementModal()">Cancel</button>
      <button class="btn-primary" (click)="makeAnnouncementFromModal()">
        Send Announcement
      </button>
    </div>
  </div>
</div>

<!-- Q&A Modal -->
<div class="modal-overlay" [class.show]="showQAModal()" (click)="closeQAModal()">
  <div class="modal-container qa-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>❓ Q&A Management</h3>
      <button class="modal-close" (click)="closeQAModal()">×</button>
    </div>
    <div class="modal-content">
      <div class="form-group">
        <label for="questionText">Question</label>
        <textarea #questionText id="questionText" 
                  placeholder="Enter your question..." 
                  class="modal-textarea" rows="3"></textarea>
      </div>
      <div class="form-group">
        <label>Question Settings</label>
        <div class="checkbox-group">
          <label>
            <input type="checkbox" #isPublicQuestion checked> Make question public
          </label>
          <label>
            <input type="checkbox" #allowAnswers checked> Allow audience answers
          </label>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" (click)="closeQAModal()">Cancel</button>
      <button class="btn-primary" (click)="askQuestionFromModal()">
        Post Question
      </button>
    </div>
  </div>
</div>